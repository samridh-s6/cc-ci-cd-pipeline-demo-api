<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<error-handler name="common-exception-handler"
		doc:id="9762ec63-a468-46ee-b7e2-4fcfec016458">
		<on-error-propagate type="CONNECTIVITY"
			logException="true" enableNotifications="true">
			<set-variable variableName="httpStatus" value="504"
				doc:name="httpStatus-504" />
			<flow-ref name="common-default-error-payload-flow" doc:name="common-default-error-payload-flow" />
		</on-error-propagate>
		<on-error-propagate type="SECURITY"
			logException="true" enableNotifications="true">
			<choice>
				<when
					expression="#[error.errorType.identifier == 'UNAUTHORIZED']">
					<set-variable variableName="httpStatus" value="401"
						doc:name="httpStatus-401" />
				</when>
				<otherwise>
					<set-variable variableName="httpStatus" value="403"
						doc:name="httpStatus-403" />
				</otherwise>
			</choice>
			<flow-ref name="common-default-error-payload-flow" doc:name="common-default-error-payload-flow" />
		</on-error-propagate>
		<on-error-propagate type="ANY" logException="true"
			enableNotifications="true">
			<choice>
				<when expression="#[(error.errorType.namespace == 'APIKIT') or (error.errorType.namespace == 'HTTP')]">
					<choice>
						<when
							expression="#[error.errorType.identifier == 'BAD_REQUEST']">
							<set-variable variableName="httpStatus" value="400"
								doc:name="httpStatus-400" />
						</when>
						<when
							expression="#[error.errorType.identifier == 'NOT_FOUND']">
							<set-variable variableName="httpStatus" value="404"
								doc:name="httpStatus-404" />
						</when>
						<when
							expression="#[error.errorType.identifier == 'METHOD_NOT_ALLOWED']">
							<set-variable variableName="httpStatus" value="405"
								doc:name="httpStatus-405" />
						</when>
						<when
							expression="#[error.errorType.identifier == 'NOT_ACCEPTABLE']">
							<set-variable variableName="httpStatus" value="406"
								doc:name="httpStatus-406" />
						</when>
						<when
							expression="#[error.errorType.identifier == 'UNSUPPORTED_MEDIA_TYPE']">
							<set-variable variableName="httpStatus" value="415"
								doc:name="httpStatus-415" />
						</when>
						<when
							expression="#[error.errorType.identifier == 'NOT_IMPLEMENTED']">
							<set-variable variableName="httpStatus" value="501"
								doc:name="httpStatus-501" />
						</when>
					</choice>
				</when>
				<otherwise>
					<set-variable variableName="httpStatus"
						value="#[if(vars.httpStatus != null) vars.httpStatus else 500]"
						doc:name="httpStatus-500" />
				</otherwise>
			</choice>
			<flow-ref name="common-default-error-payload-flow" doc:name="common-default-error-payload-flow" />
		</on-error-propagate>
	</error-handler>
	<sub-flow name="common-default-error-payload-flow">
		<set-variable value="#[%dw 2.0&#10;output application/json&#10;---&#10;if(!isEmpty(error.suppressedErrors)) &#10;  if(!isEmpty(error.suppressedErrors.description)) error.suppressedErrors.description else error.suppressedErrors&#10;else if(!isEmpty(error.childErrors))&#10;  if(!isEmpty(error.childErrors.description)) error.childErrors.description else error.childErrors&#10;else error.errorMessage.payload default error.errorMessage default error.description]" doc:name="errorMessage" doc:id="eddafe5c-5c02-492d-ae34-ff04fcf95e87" variableName="errorMessage"/>
		<ee:transform doc:name="Transform Error Message"
			doc:id="d2066f04-adef-4a84-aafb-74c5ce0a23da">
			<ee:message>
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"appName": app.name,
	"errorCode": vars.httpStatus default 500,
	"errorMessage": vars.errorMessage default error.errorMessage.payload default error.errorMessage default error.description,
	"correlationId": vars.correlationId default "BUG: Correlation ID missing",
	"timeStamp": vars.timeStamp default now(),
}]]></ee:set-payload>
			</ee:message>
			<ee:variables>
			</ee:variables>
		</ee:transform>
		<logger level="ERROR" doc:name="Error Message" doc:id="c864dde0-7579-45d8-b29e-56e3a7f99402" message="#[payload]" />
	</sub-flow>
	</mule>
